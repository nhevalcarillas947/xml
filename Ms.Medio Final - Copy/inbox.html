<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="inbox.css">
<title>Inbox - Barangay Paknaan Health Center</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #f3f4f6;
        color: #333;
    }
    .header {
        background: #2c3e50;
        padding: 20px;
        color: white;
        text-align: center;
    }
    .container {
        width: 90%;
        max-width: 900px;
        margin: 30px auto;
    }
    .title {
        font-size: 28px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .message-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: all 0.3s ease;
        border-left: 4px solid #1a73e8;
    }
    .message-card:hover {
        background: #f0f8ff;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    .msg-header {
        display: flex;
        justify-content: space-between;
        font-weight: bold;
    }
    .msg-preview {
        margin-top: 8px;
        color: #555;
    }
    .timestamp {
        font-size: 12px;
        color: #777;
    }
    .msg-details {
        margin-top: 10px;
        padding: 10px;
        background: #eef6ff;
        border-radius: 8px;
        display: none;
        font-size: 14px;
    }
    .back-btn {
        margin-top: 20px;
        display: inline-block;
        padding: 10px 15px;
        background: #2c3e50;
        color: white;
        border-radius: 6px;
        text-decoration: none;
    }
    .back-btn:hover {
        background: #1b2733;
    }
</style>
</head>

<body>
<div class="header">
    <h1><i class="fas fa-inbox"></i> Inbox Messages</h1>
</div>

<div class="container">
    <h2 class="title"><i class="fas fa-envelope-open-text"></i> Your Messages</h2>

    <!-- Dynamic Messages Container -->
    <div id="messageContainer"></div>

    <a class="back-btn" href="User.html"><i class="fas fa-arrow-left"></i> Back to Home</a>
</div>

<script>
window.onload = function () {
    const container = document.getElementById("messageContainer");

    // Get the current logged-in user's email
    const userEmail = getUserEmail();
    
    if (!userEmail) {
        container.innerHTML = `<p style="color: red;">Please login to view messages.</p>`;
        return;
    }
    
    console.log('Filtering messages for email:', userEmail);

    // Load messages from localStorage
    const messages = JSON.parse(localStorage.getItem("messages")) || [];
    console.log('Total messages in localStorage:', messages.length);
    
    // Filter messages for current user only
    const userMessages = messages.filter(msg => msg.to === userEmail);
    console.log('Filtered messages for user:', userMessages.length);
    
    // Sort messages by newest first
    userMessages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    if (userMessages.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-envelope-open" style="font-size: 60px; margin-bottom: 20px; opacity: 0.3;"></i>
                <p style="font-size: 18px; margin-bottom: 10px;">No messages yet</p>
                <p>Your appointment confirmations will appear here once scheduled.</p>
            </div>
        `;
        return;
    }

    userMessages.forEach((msg, index) => {
        // Create message card element
        const card = document.createElement('div');
        card.className = 'message-card';
        
        // Format timestamp
        const msgDate = new Date(msg.timestamp);
        const formattedDate = msgDate.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });
        const formattedTime = msgDate.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit'
        });

        card.innerHTML = `
            <div class="msg-header">
                <span><i class="fas fa-hospital"></i> ${msg.subject || 'Health Center Notification'}</span>
                <span class="timestamp">${formattedDate} ${formattedTime}</span>
            </div>
            <div class="msg-preview">From: ${msg.from} ‚Äì Click to view details</div>
            <div class="msg-details">
                <p><strong>From:</strong> ${msg.from}</p>
                <p><strong>Subject:</strong> ${msg.subject}</p>
                <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px; white-space: pre-line;">
                    ${msg.message}
                </div>
                ${msg.appointmentDetails ? `
                    <div style="margin-top: 15px; padding: 15px; background: #d4edda; border-radius: 6px; border-left: 4px solid #28a745;">
                        <p style="font-weight: bold; margin-bottom: 10px;"><i class="fas fa-calendar-check"></i> Appointment Summary:</p>
                        <p><strong>üìÖ Date:</strong> ${new Date(msg.appointmentDetails.date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</p>
                        <p><strong>‚è∞ Time:</strong> ${msg.appointmentDetails.time}</p>
                        <p><strong>üè• Service:</strong> ${msg.appointmentDetails.service}</p>
                        ${msg.appointmentDetails.notes ? `<p><strong>üìù Notes:</strong> ${msg.appointmentDetails.notes}</p>` : ''}
                    </div>
                ` : ''}
            </div>
        `;

        // Toggle details visibility on click
        card.addEventListener('click', () => {
            const details = card.querySelector('.msg-details');
            if (details.style.display === 'block') {
                details.style.display = 'none';
            } else {
                details.style.display = 'block';
                
                // Mark message as read
                if (!msg.read) {
                    markMessageAsRead(msg.id);
                }
            }
        });

        container.appendChild(card);
    });
};

// Function to get user email
function getUserEmail() {
    // Try to get email from multiple sources
    let email = sessionStorage.getItem('email');
    
    if (!email) {
        email = localStorage.getItem('userEmail');
    }
    
    if (!email) {
        const loggedInUser = localStorage.getItem('loggedInUser');
        if (loggedInUser) {
            try {
                const userObj = JSON.parse(loggedInUser);
                email = userObj.email;
            } catch (e) {
                console.error("Error parsing loggedInUser:", e);
            }
        }
    }
    
    if (!email) {
        // Try to get from users array using current username
        const username = sessionStorage.getItem('username');
        if (username) {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const user = users.find(u => u.username === username);
            if (user && user.email) {
                email = user.email;
                // Store for future use
                sessionStorage.setItem('email', user.email);
                localStorage.setItem('userEmail', user.email);
            }
        }
    }
    
    console.log('Retrieved email for inbox filtering:', email);
    return email;
}

// Function to mark message as read
function markMessageAsRead(messageId) {
    const messages = JSON.parse(localStorage.getItem("messages")) || [];
    const messageIndex = messages.findIndex(msg => msg.id === messageId);
    
    if (messageIndex !== -1) {
        messages[messageIndex].read = true;
        localStorage.setItem("messages", JSON.stringify(messages));
    }
}
</script>

</body>
</html>
